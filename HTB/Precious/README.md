# Precious

This Hack the Box machine includes a command injection vulnerability and a blind remote code execution using YAML deserialization. I used a couple of walkthroughs to help me through this but I'm extending the discussion below to be a bit more beginner friendly. This is to help explain a bit of the why behind techniques and why certain things done in this walkthrough work. You can view the `dependencies.yml` file as a seperate doc within this folder.

**Youtube Walkthrough: [Available Here]()**

# Enumeration

After connecting to the VPN and launching the machine, I `ping` the target to check the connection. Then I perform an nmap scan of the top 1000 ports.

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

Here we discover ports 22 and 80 open. I run the default scripts on port 80 as this is used for web servers by default. There's an NGINX (version 1.18.0) web server running on port 80 and it also has Phusion Passenger 6.0.15 running on it. Running `whatweb` turns up extra information but nothing to obvious at this stage.

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

I also run `gobuster` to see if there are any subdirectories that I can access. This turns up nothing.

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

Next, I navigate to the page using `precious.htb` (which I added to the `/etc/host` file). We find a page with a dialogue box and the title "Convert Web Page to PDF" written at the top (see below).

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

I start a simple http server using python3: `python3 -m http.server 80`. 

> This command calls the HTTP Server module using the `-m` flag, and utilises port 80 for the service. 

Then, I enter my IP address as a http:// address and click **Submit**. This generates a PDF document based on the directory the web server is located. 

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

I then have a look at the metadata of the PDF (after downloading it) using `exiftool`. Here I see that the PDF was generated by `pdfkit v0.8.6`. 

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

At this stage I do a bit of research into Phusion Passenger and pdfkit for any known vulnerabilities. Phusion Passenger turns up nothing helpful. On the other hand, the version of pdfkit that's running on this web server has got a critical vulnerability. Snyk has a short CVE description on the  Proof of Concept for this vulnerability. CVE-2022-25765 is a command injection vulnerability.

> Command injection is listed as A03:Injection on the OWASP Top 10 list of web vulnerabilities. Basically, this vulnerability type allows an attacker to execute code on the system. OS command injection, which is what is exploitable on this machine, is when you are able to run commands that the actual OS behind the web service. This means that an attacker is able to access the server because the web server interprets requests made to it as commands for the system and not queries that run on the application that the user is interacting with. This can be due to poor practices in securing code by leaving user input unsanitised. Or it may be that functions and methods are used that are known to be vulnerable to this kind of attack. 

In the case of Precious, pdfkit has a critical vulnerability that allows an attacker to remotely execute arbitrary code on the host OS. In terms of complexity, this attack is not that complex as it requires you to query the server at the end of your uri source e.g. `http://[ip]/%20'[command]'` ➡️ `http://10.10.14.19/%20'whoami'` 

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>


# Initial Foothold


# Privilege Escalation

## YAML Deserialization

# Root


Referenced Walkthroughs
- https://0xdedinfosec.vercel.app/blog/hackthebox-precious-writeup
- https://read.infos3c.net/hack-the-box-htb-writeup-precious

Referenced Blogs:
- https://blog.stratumsecurity.com/2021/06/09/blind-remote-code-execution-through-yaml-deserialization/
- https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795
- https://owasp.org/Top10/A03_2021-Injection/
